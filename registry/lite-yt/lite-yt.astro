---
import { cls } from '@/src/lib/utils';

interface Props {
  videoid: string;
  class?: string;
}

const { videoid, class: className } = Astro.props as Props;
---

<lite-youtube
  videoid={videoid}
  class={cls(
    `
    group relative block w-full aspect-video
    bg-black cursor-pointer

    before:absolute before:inset-0
    before:bg-(image:--yt-thumb)
    before:bg-cover before:bg-center
    before:brightness-90
    group-[.is-loaded]:before:hidden

    after:absolute after:inset-0
    after:bg-[url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 68 48\"><path d=\"M66.52 7.15a8 8 0 0 0-5.6-5.66C55.73 0 34 0 34 0S12.27 0 7.08 1.49A8 8 0 0 0 1.48 7.15C0 12.33 0 24 0 24s0 11.67 1.48 16.85a8 8 0 0 0 5.6 5.66C12.27 48 34 48 34 48s21.73 0 26.92-1.49a8 8 0 0 0 5.6-5.66C68 35.67 68 24 68 24s0-11.67-1.48-16.85z\" fill=\"%23f00\"/><polygon points=\"45,24 27,14 27,34\" fill=\"%23fff\"/></svg>')]
    after:bg-no-repeat after:bg-center
    after:bg-size-[68px_48px]
    group-[.is-loaded]:after:hidden
  `,
    className
  )}></lite-youtube>

<script>
  class LiteYouTube extends HTMLElement {
    connectedCallback() {
      const id = this.getAttribute('videoid');
      if (!id) return;

      this.style.setProperty('--yt-thumb', `url(https://i.ytimg.com/vi/${id}/hqdefault.jpg)`);

      this.setAttribute('role', 'button');
      this.setAttribute('tabindex', '0');
      this.setAttribute('aria-label', 'Play YouTube video');

      this.addEventListener('click', this.load, { once: true });
      this.addEventListener(
        'keydown',
        e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.load();
          }
        },
        { once: true }
      );
    }

    load = () => {
      const id = this.getAttribute('videoid');
      this.classList.add('before:none');

      this.classList.add('is-loaded');

      const iframe = document.createElement('iframe');
      iframe.src =
        `https://www.youtube-nocookie.com/embed/${id}` +
        `?autoplay=1&controls=1&playsinline=1&rel=0`;

      iframe.allow =
        'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
      iframe.allowFullscreen = true;
      iframe.className = 'w-full h-full border-0 relative z-50';

      this.innerHTML = '';
      this.appendChild(iframe);
    };
  }

  if (!customElements.get('lite-youtube')) {
    customElements.define('lite-youtube', LiteYouTube);
  }
</script>
